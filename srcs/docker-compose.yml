version: '3'

services:
    mariadb:
        build:
            context: ./requirements/mariadb
            dockerfile: Dockerfile
        container_name: mariadb
        restart: unless-stopped
        env_file: .env
        environment:
           - MARIADB_DATABASE=wordpress
           - MARIADB_ROOT_PASSWORD_FILE=/run/secrets/db_root_password
           - MARIADB_PASSWORD_FILE=/run/secrets/db_password
        volumes:
           - $SUDO_HOME/data/mariadb:/var/lib/mysql
        networks:
           - inception
        secrets:
           - db_root_password
           - db_password

    wordpress:
         depends_on:
           - mariadb
         build:
            context: ./requirements/wordpress
            dockerfile: Dockerfile
         container_name: wordpress
         restart: unless-stopped
         env_file: .env
         environment:
           - WORDPRESS_DB_HOST=mariadb
           - WORDPRESS_DB_USER=$MARIADB_USER
           - WORDPRESS_DB_PASSWORD_FILE=/run/secrets/db_password
           - WORDPRESS_DB_NAME=wordpress
         volumes:
           - $SUDO_HOME/data/wordpress:/var/www/html
         networks:
           - inception
         secrets:
           - db_password

    nginx:
         depends_on:
           - wordpress
         build:
            context: ./requirements/nginx
            dockerfile: Dockerfile
         #image: nginx:custom
         container_name: nginx
         restart: unless-stopped
         ports:
           - "443:443"
         volumes:
           - $SUDO_HOME/data/wordpress:/var/www/html
         networks:
           - inception

networks:
    inception:
          driver: bridge

secrets:
    db_root_password:
          file: ../secrets/db_root_password.txt
    db_password:
          file: ../secrets/db_password.txt
